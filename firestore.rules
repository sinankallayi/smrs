rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // =========================================================================
    // HELPER FUNCTIONS
    // =========================================================================
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isSuperAdmin(userData) {
      return userData.role == 'superAdmin';
    }

    function isManagement(userData) {
      return userData.role in ['management', 'md', 'exd', 'hr'];
    }

    function isSectionHead(userData) {
      return userData.role == 'sectionHead';
    }

    function isStaff(userData) {
      return userData.role == 'staff';
    }

    // =========================================================================
    // COLLECTIONS
    // =========================================================================

    // USERS COLLECTION
    // USERS COLLECTION
    match /users/{userId} {
      // Users can read/update their own profile.
      allow update: if request.auth != null && request.auth.uid == userId;
      
      // Allow GET (fetching specific doc) only if authorized
      allow get: if request.auth != null && (
          request.auth.uid == userId || 
          isManagement(getUserData()) || 
          isSuperAdmin(getUserData())
      );

      // Allow LIST (queries) for everyone to support EmployeeID login lookup
      allow list: if true;
      
      // Super Admin and Management can create/update/delete any user.
      // Note: Management encompasses HR, ExD, MD.
      allow write: if request.auth != null && (isSuperAdmin(getUserData()) || isManagement(getUserData()));

      // Section Heads might need to create staff in their section?
      // Based on previous prompt "move adding option to sectionhead management page", 
      // Section Heads should probably be allowed to write users too (at least create/update).
      // Let's allow Section Heads to write for now to avoid blocking them too.
       allow write: if request.auth != null && (
         isSuperAdmin(getUserData()) || 
         isManagement(getUserData()) || 
         isSectionHead(getUserData())
       );
    }

    // LEAVES COLLECTION
    match /leaves/{leaveId} {
      // Create: Staff can create their own requests
      allow create: if request.auth != null && 
                   request.resource.data.userId == request.auth.uid;
      
      // Read:
      // Temporarily relaxed to allow all authenticated users to read leaves.
      // Logic is handled client-side.
      allow read: if request.auth != null;
      
      // Update:
      // 1. Management can update (Approve/Reject).
      // 2. Section Heads can update leaves from their section (Forward/Reject/Finalize).
      // 3. Super Admin can update anything.
      allow update: if request.auth != null && (
        isManagement(getUserData()) ||
        isSuperAdmin(getUserData()) ||
        (isSectionHead(getUserData()) && resource.data.userSection == getUserData().section)
      );

      // Delete: Management and Super Admin
      allow delete: if request.auth != null && (isManagement(getUserData()) || isSuperAdmin(getUserData()));
    }

    // CONFIGURATIONS (Leave Flow, etc.)
    match /configurations/{configId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && isSuperAdmin(getUserData());
    }

    // SETTINGS COLLECTION (Roles & Sections)
    match /settings/{document} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isSuperAdmin(getUserData());
    }
  }
}
